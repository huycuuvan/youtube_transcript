{
  "name": "Facebook Messenger Auto Reply - AI Customer Service",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "facebook-messenger",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Facebook Messenger Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "facebook-messenger-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"status\": \"ok\" } }}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Parse Facebook Messenger Webhook payload\nconst body = $input.item.json;\n\n// Facebook webhook verification (GET request)\nif ($input.item.json['hub.mode'] === 'subscribe' && $input.item.json['hub.verify_token']) {\n  const verifyToken = $input.item.json['hub.verify_token'];\n  const challenge = $input.item.json['hub.challenge'];\n  const expectedToken = '{{ $env.FACEBOOK_VERIFY_TOKEN }}';\n  \n  if (verifyToken === expectedToken) {\n    return {\n      json: {\n        verified: true,\n        challenge: challenge\n      }\n    };\n  }\n}\n\n// Parse incoming message\nconst entry = body.entry?.[0];\nconst messaging = entry?.messaging?.[0];\n\nif (messaging && messaging.message && !messaging.message.is_echo) {\n  const senderId = messaging.sender.id;\n  const recipientId = messaging.recipient.id;\n  const messageText = messaging.message.text || '';\n  const messageId = messaging.message.mid;\n  const timestamp = messaging.timestamp;\n  \n  return {\n    json: {\n      senderId: senderId,\n      pageId: recipientId,\n      messageText: messageText,\n      messageId: messageId,\n      timestamp: timestamp,\n      hasMessage: true\n    }\n  };\n}\n\n// If no message, return empty\nreturn {\n  json: {\n    hasMessage: false\n  }\n};"
      },
      "id": "parse-facebook-webhook",
      "name": "Parse Facebook Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-has-message",
              "leftValue": "={{ $json.hasMessage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-has-message",
      "name": "Check Has Message",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Check if message is a simple/common question\nconst messageText = ($input.item.json.messageText || '').toLowerCase();\n\n// Keywords for simple questions\nconst simpleKeywords = [\n  'd·ªãch v·ª•', 'dich vu', 'service',\n  's·∫£n ph·∫©m', 'san pham', 'product',\n  'gi√°', 'gia', 'price', 'pricing',\n  'ƒë·ªãa ch·ªâ', 'dia chi', 'address', 'location',\n  'gi·ªù m·ªü c·ª≠a', 'gio mo cua', 'opening hours', 'hours',\n  'li√™n h·ªá', 'lien he', 'contact', 'phone', 's·ªë ƒëi·ªán tho·∫°i',\n  'website', 'web',\n  'ch√†o', 'chao', 'hello', 'hi',\n  'c·∫£m ∆°n', 'cam on', 'thank',\n  't∆∞ v·∫•n', 'tu van', 'consultation',\n  'ƒë·∫∑t h√†ng', 'dat hang', 'order',\n  'giao h√†ng', 'giao hang', 'delivery',\n  'thanh to√°n', 'thanh toan', 'payment'\n];\n\n// Check if message contains simple keywords\nconst isSimpleQuestion = simpleKeywords.some(keyword => \n  messageText.includes(keyword)\n);\n\n// Check message length (very long messages might be complex)\nconst isShortMessage = messageText.length < 200;\n\n// Determine if it's a simple question\nconst isSimple = isSimpleQuestion && isShortMessage;\n\nreturn {\n  json: {\n    ...$input.item.json,\n    isSimpleQuestion: isSimple,\n    messageLength: messageText.length,\n    matchedKeywords: simpleKeywords.filter(k => messageText.includes(k))\n  }\n};"
      },
      "id": "classify-message",
      "name": "Classify Message Type",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-simple-question",
              "leftValue": "={{ $json.isSimpleQuestion }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-question-type",
      "name": "Check Question Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "// Load company data (can be from env, database, or hardcoded)\nconst companyData = {\n  name: '{{ $env.COMPANY_NAME || \"C√¥ng ty c·ªßa b·∫°n\" }}',\n  services: [\n    '{{ $env.COMPANY_SERVICES || \"D·ªãch v·ª• t∆∞ v·∫•n, D·ªãch v·ª• thi·∫øt k·∫ø\" }}'\n  ].flat(),\n  products: [\n    '{{ $env.COMPANY_PRODUCTS || \"S·∫£n ph·∫©m A, S·∫£n ph·∫©m B\" }}'\n  ].flat(),\n  address: '{{ $env.COMPANY_ADDRESS || \"123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ, TP.HCM\" }}',\n  phone: '{{ $env.COMPANY_PHONE || \"0123456789\" }}',\n  email: '{{ $env.COMPANY_EMAIL || \"contact@company.com\" }}',\n  website: '{{ $env.COMPANY_WEBSITE || \"https://company.com\" }}',\n  openingHours: '{{ $env.COMPANY_HOURS || \"Th·ª© 2 - Th·ª© 6: 8:00 - 17:00\" }}',\n  prices: {\n    '{{ $env.COMPANY_PRICE_1 || \"D·ªãch v·ª• A\" }}': '{{ $env.COMPANY_PRICE_1_VALUE || \"1,000,000 VNƒê\" }}',\n    '{{ $env.COMPANY_PRICE_2 || \"D·ªãch v·ª• B\" }}': '{{ $env.COMPANY_PRICE_2_VALUE || \"2,000,000 VNƒê\" }}'\n  }\n};\n\nconst messageText = $input.item.json.messageText;\n\nreturn {\n  json: {\n    ...$input.item.json,\n    companyData: companyData,\n    prompt: `B·∫°n l√† nh√¢n vi√™n chƒÉm s√≥c kh√°ch h√†ng chuy√™n nghi·ªáp c·ªßa ${companyData.name}.\n\nTh√¥ng tin c√¥ng ty:\n- T√™n: ${companyData.name}\n- D·ªãch v·ª•: ${companyData.services.join(', ')}\n- S·∫£n ph·∫©m: ${companyData.products.join(', ')}\n- ƒê·ªãa ch·ªâ: ${companyData.address}\n- ƒêi·ªán tho·∫°i: ${companyData.phone}\n- Email: ${companyData.email}\n- Website: ${companyData.website}\n- Gi·ªù m·ªü c·ª≠a: ${companyData.openingHours}\n- B·∫£ng gi√°:\n${Object.entries(companyData.prices).map(([k, v]) => `  ${k}: ${v}`).join('\\n')}\n\nKh√°ch h√†ng h·ªèi: \"${messageText}\"\n\nH√£y tr·∫£ l·ªùi m·ªôt c√°ch th√¢n thi·ªán, chuy√™n nghi·ªáp, ng·∫Øn g·ªçn (t·ªëi ƒëa 200 t·ª´). N·∫øu kh√¥ng c√≥ th√¥ng tin, h√£y ƒë·ªÅ ngh·ªã kh√°ch h√†ng li√™n h·ªá tr·ª±c ti·∫øp.\n\nTr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát:`\n  }\n};"
      },
      "id": "prepare-ai-prompt",
      "name": "Prepare AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.OPENAI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"B·∫°n l√† nh√¢n vi√™n chƒÉm s√≥c kh√°ch h√†ng chuy√™n nghi·ªáp, th√¢n thi·ªán v√† nhi·ªát t√¨nh.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"{{ $json.prompt }}\"\n    }\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 300\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-agent",
      "name": "AI Agent (OpenAI)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "jsCode": "// Extract AI response\nconst response = $input.item.json;\nconst aiResponse = response.choices?.[0]?.message?.content || 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y. Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp v·ªõi ch√∫ng t√¥i.';\n\nreturn {\n  json: {\n    ...$('Prepare AI Prompt').item.json,\n    aiResponse: aiResponse.trim()\n  }\n};"
      },
      "id": "extract-ai-response",
      "name": "Extract AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.FACEBOOK_PAGE_ACCESS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.senderId }}\"\n  },\n  \"message\": {\n    \"text\": \"{{ $json.aiResponse }}\"\n  }\n}",
        "options": {}
      },
      "id": "send-facebook-reply",
      "name": "Send Facebook Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.FACEBOOK_PAGE_ACCESS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.senderId }}\"\n  },\n  \"message\": {\n    \"text\": \"C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá! C√¢u h·ªèi c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ƒë·ªôi ng≈© t∆∞ v·∫•n. Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi trong th·ªùi gian s·ªõm nh·∫•t.\\n\\nTin nh·∫Øn c·ªßa b·∫°n: {{ $json.messageText }}\"\n  }\n}",
        "options": {}
      },
      "id": "send-acknowledgment",
      "name": "Send Acknowledgment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.NOTIFICATION_WEBHOOK_URL || 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK' }}",
        "authentication": "none",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"text\": \"üîî C√¢u h·ªèi c·∫ßn x√°c nh·∫≠n t·ª´ Facebook Messenger\\n\\nNg∆∞·ªùi g·ª≠i: {{ $json.senderId }}\\nTin nh·∫Øn: {{ $json.messageText }}\\n\\nVui l√≤ng ph·∫£n h·ªìi qua Facebook Page ho·∫∑c approve tin nh·∫Øn n√†y.\",\n  \"username\": \"Facebook Messenger Bot\",\n  \"icon_emoji\": \":speech_balloon:\"\n}",
        "options": {}
      },
      "id": "notify-human",
      "name": "Notify Human (Slack/Email)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "jsCode": "// Log the conversation for review\nconst data = $input.item.json;\n\nreturn {\n  json: {\n    timestamp: new Date().toISOString(),\n    senderId: data.senderId,\n    messageText: data.messageText,\n    messageType: data.isSimpleQuestion ? 'simple' : 'complex',\n    status: 'pending_review'\n  }\n};"
      },
      "id": "log-conversation",
      "name": "Log Conversation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "Facebook Messenger Webhook": {
      "main": [
        [
          {
            "node": "Parse Facebook Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Facebook Webhook": {
      "main": [
        [
          {
            "node": "Check Has Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Has Message": {
      "main": [
        [
          {
            "node": "Classify Message Type",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Classify Message Type": {
      "main": [
        [
          {
            "node": "Check Question Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Question Type": {
      "main": [
        [
          {
            "node": "Prepare AI Prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Acknowledgment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare AI Prompt": {
      "main": [
        [
          {
            "node": "AI Agent (OpenAI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (OpenAI)": {
      "main": [
        [
          {
            "node": "Extract AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract AI Response": {
      "main": [
        [
          {
            "node": "Send Facebook Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Acknowledgment": {
      "main": [
        [
          {
            "node": "Notify Human (Slack/Email)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Human (Slack/Email)": {
      "main": [
        [
          {
            "node": "Log Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-20T00:00:00.000Z",
  "versionId": "1"
}

